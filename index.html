<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>YourGPT</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YourGPT">
    <meta name="description" content="YourGPT - Your personal AI assistant">
    <meta name="keywords" content="AI, chatbot, assistant, YourGPT">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z'/></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Futuristic Theme Variables */
        :root {
            --primary-neon: #00ffff;
            --secondary-neon: #ff00ff;
            --accent-neon: #00ff00;
            --warning-neon: #ffff00;
            --bg-dark: #0a0a0a;
            --bg-darker: #050505;
            --bg-card: rgba(15, 15, 15, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --border-neon: rgba(0, 255, 255, 0.3);
            --shadow-neon: 0 0 20px rgba(0, 255, 255, 0.3);
            --shadow-neon-strong: 0 0 30px rgba(0, 255, 255, 0.6);
        }

        /* Mobile-first responsive design */
        * {
            box-sizing: border-box;
        }
        
        html {
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 0, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            z-index: -2;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        /* Grid Pattern Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            animation: gridMove 30s linear infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        /* Mobile-specific body adjustments */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                overflow: hidden;
                -webkit-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Fix main layout for mobile */
            .mobile-layout {
                height: 100vh;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Mobile chat container */
            #chat-container {
                height: calc(100vh - 140px);
                height: calc(100dvh - 140px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.75rem;
                overscroll-behavior: contain;
            }
            
            /* Mobile header */
            header {
                flex-shrink: 0;
                height: auto;
                min-height: 60px;
                padding: 0.75rem;
            }
            
        /* Mobile input area - Enhanced alignment */
        #chat-form {
            flex-shrink: 0;
            margin: 0 0.75rem 0.75rem 0.75rem;
            padding: 0.75rem;
            border-radius: 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-neon);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 60px;
        }
            
            /* Mobile welcome screen */
            #welcome-screen {
                height: calc(100vh - 200px);
                height: calc(100dvh - 200px);
                padding: 1.5rem 0.75rem;
            }
            
            /* Mobile modals */
            .modal-content {
                max-height: 90vh;
                max-height: 90dvh;
                margin: 0.5rem;
                border-radius: 16px;
            }
            
            /* Mobile message bubbles */
            .message {
                max-width: 100%;
                margin: 0.5rem 0;
            }
            
            .message-content {
                padding: 0.75rem;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* Mobile buttons - Enhanced touch targets */
            button {
                min-height: 48px; /* Larger touch target for better mobile UX */
                min-width: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                border-radius: 12px;
            }
            
            /* Mobile input fields */
            input, textarea, select {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 52px;
                border-radius: 16px;
                padding: 14px 18px;
                border: 2px solid var(--border-neon);
                background: rgba(0, 0, 0, 0.3);
                color: var(--text-primary);
                transition: all 0.3s ease;
            }
            
            /* Mobile input focus state */
            input:focus, textarea:focus {
                outline: none;
                border-color: var(--primary-neon);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
                background: rgba(0, 255, 255, 0.05);
            }
            
            /* Mobile input placeholder */
            input::placeholder, textarea::placeholder {
                color: var(--text-muted);
                opacity: 0.8;
            }
            
            /* Mobile action buttons */
            .copy-btn, .fact-check-btn, .refine-btn, .tts-btn {
                min-height: 48px !important;
                min-width: 48px !important;
                padding: 12px !important;
            }
            
            /* Mobile sidebar */
            #sidebar {
                width: 100vw;
                max-width: 320px;
            }
            
            /* Mobile header buttons */
            .btn-futuristic, .btn-neon-primary {
                min-height: 48px;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            /* Mobile typing area buttons - Enhanced alignment */
            #chat-form button {
                min-height: 48px !important;
                min-width: 48px !important;
                border-radius: 16px !important;
                padding: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                flex-shrink: 0 !important;
                margin: 0 !important;
                position: relative;
                z-index: 1;
            }
            
            /* Mobile chat form layout */
            #chat-form {
                display: flex !important;
                align-items: center !important;
                gap: 6px !important;
                padding: 8px !important;
            }
            
            /* Mobile input field alignment - Enhanced */
            #message-input {
                flex: 1 !important;
                min-height: 48px !important;
                border-radius: 16px !important;
                padding: 12px 16px !important;
                display: block !important;
                margin: 0 !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                line-height: 1.4 !important;
                box-sizing: border-box !important;
                width: 100% !important;
                max-width: 100% !important;
                position: relative;
                z-index: 1;
                vertical-align: top !important;
                text-align: left !important;
                white-space: nowrap !important;
                overflow: hidden !important;
            }
            
            /* Mobile send button enhancement */
            #chat-form button[type="submit"] {
                background: linear-gradient(135deg, var(--primary-neon), var(--secondary-neon));
                border: 2px solid var(--primary-neon);
                box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);
                transition: all 0.3s ease;
            }
            
            #chat-form button[type="submit"]:active {
                transform: scale(0.95);
                box-shadow: 0 2px 10px rgba(0, 255, 255, 0.5);
            }
            
            /* Mobile action buttons in typing area */
            #chat-form .btn-futuristic {
                background: var(--bg-glass);
                border: 2px solid var(--border-neon);
                backdrop-filter: blur(15px);
            }
            
            #chat-form .btn-futuristic:active {
                transform: scale(0.95);
                border-color: var(--primary-neon);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            }
            
            /* Keyboard open adjustments */
            .keyboard-open #chat-container {
                height: calc(100vh - 200px) !important;
                height: calc(100dvh - 200px) !important;
            }
            
            .keyboard-open #welcome-screen {
                height: calc(100vh - 250px) !important;
                height: calc(100dvh - 250px) !important;
            }
            
            /* Mobile typography */
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            /* Mobile glass cards */
            .glass-card {
                border-radius: 16px;
                padding: 1rem;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            #chat-container {
                padding: 0.5rem;
            }
            
            #chat-form {
                margin: 0 0.5rem 0.5rem 0.5rem;
                padding: 0.5rem;
                min-height: 56px;
                gap: 6px;
            }
            
            .message-content {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            #welcome-screen {
                padding: 1rem 0.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            /* Extra small buttons */
            button {
                min-height: 44px;
                min-width: 44px;
                padding: 10px 12px;
                font-size: 13px;
            }
            
            /* Extra small input fields */
            input, textarea, select {
                min-height: 48px;
                padding: 12px 14px;
                font-size: 16px;
                border-radius: 14px;
            }
            
            /* Extra small typing area */
            #chat-form {
                margin: 0 0.5rem 0.5rem 0.5rem;
                padding: 0.5rem;
                border-radius: 16px;
            }
            
            /* Extra small typing buttons */
            #chat-form button {
                min-height: 48px !important;
                min-width: 48px !important;
                border-radius: 14px !important;
                padding: 12px !important;
                flex-shrink: 0 !important;
                margin: 0 !important;
            }
            
            /* Extra small chat form layout */
            #chat-form {
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                padding: 6px !important;
            }
            
            /* Extra small input field - Enhanced alignment */
            #message-input {
                flex: 1 !important;
                min-height: 48px !important;
                border-radius: 14px !important;
                padding: 12px 14px !important;
                margin: 0 !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                line-height: 1.4 !important;
                box-sizing: border-box !important;
                width: 100% !important;
                max-width: 100% !important;
                position: relative;
                z-index: 1;
                display: block !important;
                vertical-align: top !important;
                text-align: left !important;
                white-space: nowrap !important;
                overflow: hidden !important;
            }
            
            /* Extra small header */
            header {
                padding: 0.5rem;
                min-height: 56px;
            }
            
            /* Extra small modals */
            .modal-content {
                margin: 0.25rem;
                border-radius: 12px;
            }
            
            /* Extra small sidebar */
            #sidebar {
                width: 100vw;
                max-width: 280px;
            }
        }
        body::-webkit-scrollbar, #chat-history-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #4f4f4f;
            border-radius: 20px;
            border: 3px solid #1e1e1e;
        }
        #chat-history-container {
             scrollbar-width: thin;
             scrollbar-color: #4f4f4f #1e1e1e;
        }
        #chat-history-container:hover::-webkit-scrollbar {
            display: block;
        }
         #chat-history-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history-container::-webkit-scrollbar-thumb {
            background-color: #4f4f4f;
            border-radius: 4px;
        }
        /* Futuristic Button Styles */
        .btn-futuristic {
            background: linear-gradient(135deg, var(--bg-glass), var(--bg-card));
            border: 1px solid var(--border-neon);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-futuristic::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-futuristic:hover {
            border-color: var(--primary-neon);
            box-shadow: var(--shadow-neon);
            transform: translateY(-2px);
        }

        .btn-futuristic:hover::before {
            left: 100%;
        }

        .btn-futuristic:active {
            transform: translateY(0);
            box-shadow: var(--shadow-neon-strong);
        }

        /* Primary Neon Button */
        .btn-neon-primary {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            border: 2px solid var(--primary-neon);
            color: var(--primary-neon);
            text-shadow: 0 0 10px var(--primary-neon);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .btn-neon-primary:hover {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
            text-shadow: 0 0 20px var(--primary-neon);
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-neon);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: var(--primary-neon);
            box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);
            transform: translateY(-4px);
        }

        /* Message Bubbles with Futuristic Style */
        .message-bubble {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            animation: slideUpFuturistic 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-neon);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Smooth Bot Message Animation */
        .message-bubble.bot-message {
            opacity: 0;
            transform: translateX(-30px) translateY(10px) scale(0.9);
            animation: botMessageSlideIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .message-bubble.user-message {
            opacity: 0;
            transform: translateX(30px) translateY(10px) scale(0.9);
            animation: userMessageSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes botMessageSlideIn {
            0% {
                opacity: 0;
                transform: translateX(-30px) translateY(10px) scale(0.9);
                filter: blur(2px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            50% {
                opacity: 0.7;
                transform: translateX(-10px) translateY(5px) scale(0.95);
                filter: blur(1px);
                box-shadow: 0 8px 30px rgba(255, 0, 255, 0.3);
            }
            100% {
                opacity: 1;
                transform: translateX(0) translateY(0) scale(1);
                filter: blur(0);
                box-shadow: 0 4px 20px rgba(255, 0, 255, 0.2);
            }
        }

        @keyframes userMessageSlideIn {
            0% {
                opacity: 0;
                transform: translateX(30px) translateY(10px) scale(0.9);
                filter: blur(2px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            50% {
                opacity: 0.7;
                transform: translateX(10px) translateY(5px) scale(0.95);
                filter: blur(1px);
                box-shadow: 0 8px 30px rgba(0, 255, 255, 0.3);
            }
            100% {
                opacity: 1;
                transform: translateX(0) translateY(0) scale(1);
                filter: blur(0);
                box-shadow: 0 4px 20px rgba(0, 255, 255, 0.2);
            }
        }

        .message-bubble.user {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            border-color: var(--primary-neon);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.2);
        }

        .message-bubble.assistant {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.05));
            border-color: var(--secondary-neon);
            box-shadow: 0 4px 20px rgba(255, 0, 255, 0.2);
        }

        @keyframes slideUpFuturistic {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* Futuristic Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-neon);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .typing-indicator span {
            height: 8px; 
            width: 8px; 
            background: var(--primary-neon);
            display: inline-block; 
            border-radius: 50%;
            animation: neonBounce 1.4s infinite ease-in-out both;
            box-shadow: 0 0 10px var(--primary-neon);
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes neonBounce {
            0%, 80%, 100% { 
                transform: scale(0);
                box-shadow: 0 0 5px var(--primary-neon);
            }
            40% { 
                transform: scale(1.0);
                box-shadow: 0 0 15px var(--primary-neon);
            }
        }
        
        /* Futuristic Modal Styles */
        .modal-overlay {
            opacity: 0; 
            visibility: hidden;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.active { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-neon);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9) translateY(20px); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.active .modal-content { 
            transform: scale(1) translateY(0); 
        }
        
        /* Futuristic Loader */
        .loader {
            width: 48px; 
            height: 48px; 
            border: 3px solid transparent;
            border-top: 3px solid var(--primary-neon);
            border-right: 3px solid var(--secondary-neon);
            border-radius: 50%;
            display: inline-block; 
            box-sizing: border-box;
            animation: neonRotation 1s linear infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        @keyframes neonRotation {
            0% { 
                transform: rotate(0deg);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            }
            100% { 
                transform: rotate(360deg);
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            }
        }

        /* Futuristic Input Fields */
        .input-futuristic {
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-neon);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        /* Chat form alignment - General */
        #chat-form {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        
        #message-input {
            flex: 1;
            display: block;
            margin: 0;
            vertical-align: top;
            text-align: left;
        }
        
        #chat-form button {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        .input-futuristic:focus {
            outline: none;
            border-color: var(--primary-neon);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            background: rgba(0, 255, 255, 0.05);
        }

        .input-futuristic::placeholder {
            color: var(--text-muted);
        }

        /* Futuristic Scrollbars */
        .futuristic-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .futuristic-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-darker);
            border-radius: 4px;
        }

        .futuristic-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-neon), var(--secondary-neon));
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .futuristic-scrollbar::-webkit-scrollbar-thumb:hover {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }

        /* Glow Effects */
        .glow-neon {
            box-shadow: 0 0 20px var(--primary-neon);
            animation: glowPulse 2s ease-in-out infinite alternate;
        }

        @keyframes glowPulse {
            from {
                box-shadow: 0 0 20px var(--primary-neon);
            }
            to {
                box-shadow: 0 0 30px var(--primary-neon), 0 0 40px var(--primary-neon);
            }
        }

        /* Action Button Icon Centering */
        .copy-btn, .fact-check-btn, .refine-btn, .tts-btn, .download-image-btn {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .copy-btn svg, .fact-check-btn svg, .refine-btn svg, .tts-btn svg, .download-image-btn svg {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Download button specific styling */
        .download-image-btn {
            background: var(--bg-glass) !important;
            backdrop-filter: blur(15px) !important;
            border: 2px solid var(--border-neon) !important;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.2) !important;
            transition: all 0.3s ease !important;
        }
        
        .download-image-btn:hover {
            border-color: var(--primary-neon) !important;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4) !important;
            transform: scale(1.05) !important;
        }
        
        .download-image-btn:active {
            transform: scale(0.95) !important;
        }

        /* Text Glow Effects */
        .text-glow {
            text-shadow: 0 0 10px currentColor;
        }

        .text-glow-strong {
            text-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
        }

        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Reduce animations on mobile for better performance */
            .message-bubble {
                animation-duration: 0.4s;
            }
            
            /* Optimize backdrop filters for mobile */
            .glass-card {
                backdrop-filter: blur(10px);
            }
            
            /* Reduce glow effects on mobile */
            .glow-neon {
                animation: none;
                box-shadow: 0 0 15px var(--primary-neon);
            }
            
            /* Optimize grid animation for mobile */
            body::after {
                animation-duration: 60s;
            }
            
            /* Better touch feedback */
            button:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            /* Improve scrolling performance */
            #chat-container {
                will-change: scroll-position;
                transform: translateZ(0);
            }
            
            /* Optimize message bubbles for mobile */
            .message-bubble {
                will-change: transform, opacity;
            }
        }

        /* Mobile Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            @media (max-width: 768px) {
                /* Fix iOS viewport issues */
                body {
                    -webkit-overflow-scrolling: touch;
                }
                
                /* Fix iOS input zoom */
                input[type="text"], input[type="email"], textarea {
                    font-size: 16px !important;
                    transform: translateZ(0);
                }
                
                /* Fix iOS button highlighting */
                button {
                    -webkit-tap-highlight-color: transparent;
                    -webkit-touch-callout: none;
                    -webkit-user-select: none;
                user-select: none;
                }
                
                /* iOS typing area enhancements */
                #chat-form {
                    -webkit-transform: translateZ(0);
                    transform: translateZ(0);
                }
                
                /* iOS input focus improvements */
                #message-input:focus {
                    -webkit-appearance: none;
                    appearance: none;
                }
            }
        }
        
        /* Mobile typing area animations */
        @media (max-width: 768px) {
            #chat-form {
                animation: slideUpMobile 0.3s ease-out;
            }
            
            @keyframes slideUpMobile {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            /* Mobile input glow effect */
            #message-input:focus {
                animation: inputGlow 2s ease-in-out infinite alternate;
            }
            
            @keyframes inputGlow {
                from {
                    box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
                }
                to {
                    box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
                }
            }
        }
        
        /* Mobile sidebar styles */
        @media (max-width: 768px) {
            #sidebar {
                width: 280px;
            }
            
            #sidebar-overlay {
                backdrop-filter: blur(4px);
            }
            
            /* Prevent body scroll when sidebar is open */
            body.sidebar-open {
                overflow: hidden;
            }
            
            /* Mobile sidebar button styling */
            #mobile-sidebar-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 200 !important;
                position: relative;
                background-color: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(4px);
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            
            /* Mobile close sidebar button styling */
            #close-sidebar-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(4px);
                border-radius: 8px;
                transition: all 0.2s ease;
                position: relative;
                z-index: 10;
                pointer-events: auto;
                cursor: pointer;
            }
            
            #close-sidebar-btn:hover {
                background-color: rgba(255, 0, 0, 0.1);
                border-color: rgba(255, 0, 0, 0.3);
                color: #ff6b6b;
            }
            
            #close-sidebar-btn:active {
                transform: scale(0.95);
            }
            
            /* Ensure close button is always clickable */
            #close-sidebar-btn {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                touch-action: manipulation;
            }
            
            /* Make sure close button is visible on mobile */
            @media (max-width: 768px) {
                #close-sidebar-btn {
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                }
            }
            
            /* Enhanced sidebar sliding animations */
            #sidebar {
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
                will-change: transform, opacity;
            }
            
            /* Smooth overlay transitions */
            #sidebar-overlay {
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }
            
            /* Touch feedback for sidebar */
            #sidebar:active {
                transition: none;
            }
            
            #mobile-sidebar-btn:hover {
                background-color: rgba(0, 0, 0, 0.2);
            }
            
            /* Ensure mobile sidebar button is always visible */
            #mobile-sidebar-btn {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            
            /* Sidebar New Chat button mobile styling */
            #new-chat-sidebar-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            /* Delete buttons mobile styling */
            .delete-chat-btn {
                min-width: 44px;
                min-height: 44px;
                touch-action: manipulation;
                opacity: 1 !important; /* Always visible on mobile */
                background-color: rgba(239, 68, 68, 0.1); /* Subtle red background */
                border: 1px solid rgba(239, 68, 68, 0.2);
            }
            
            .delete-chat-btn:hover {
                background-color: rgba(239, 68, 68, 0.2);
                border-color: rgba(239, 68, 68, 0.4);
            }
            
            .delete-chat-btn:active {
                transform: scale(0.95);
                background-color: rgba(239, 68, 68, 0.3);
            }
            
            #bulk-delete-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            /* Make delete buttons always visible on mobile */
            .group .delete-chat-btn {
                opacity: 1 !important;
            }
        }
        
        /* Desktop styling - hide delete buttons by default, show on hover */
        @media (min-width: 769px) {
            .delete-chat-btn {
                opacity: 0;
                transition: opacity 0.2s ease;
            }
            
            .group:hover .delete-chat-btn {
                opacity: 1;
            }
        }
        
        /* Mobile message improvements */
        .message-bubble .group {
            max-width: 100% !important;
        }
        
        .message-bubble .group > div:last-child {
            max-width: calc(100vw - 80px);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Mobile input improvements - Enhanced */
        #message-input {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            resize: none;
            overflow: hidden;
            font-family: inherit;
            line-height: 1.4;
            max-height: 120px;
            min-height: 48px;
            display: block;
            vertical-align: top;
            text-align: left;
            white-space: nowrap;
        }
        
        /* Mobile input container improvements */
        #chat-form {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            will-change: transform;
        }
        
        /* Mobile input focus improvements */
        #message-input:focus {
            -webkit-appearance: none;
            appearance: none;
            outline: none;
            border: none;
        }
        
        /* Touch-friendly buttons - Enhanced */
        button, .clickable {
            min-height: 44px;
            min-width: 44px;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Mobile form container improvements */
        @media (max-width: 768px) {
            #chat-form {
                position: sticky;
                bottom: 0;
                z-index: 100;
                margin-bottom: env(safe-area-inset-bottom, 0.75rem);
            }
            
            
            /* Ensure proper spacing on mobile */
            #chat-form * {
                box-sizing: border-box;
            }
            
            /* Mobile input field improvements */
            #message-input {
                -webkit-appearance: none;
                appearance: none;
                border: none;
                outline: none;
                background: transparent;
                color: var(--text-primary);
                resize: none;
                overflow: hidden;
                font-family: inherit;
                line-height: 1.4;
                max-height: 120px;
                min-height: 48px;
                vertical-align: top;
                display: block;
                text-align: left;
                white-space: nowrap;
            }
            
            /* Mobile button improvements */
            #chat-form button {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                user-select: none;
                touch-action: manipulation;
            }
        }
        
        /* Mobile modal improvements */
        .modal-content {
            margin: 1rem;
            max-height: calc(100vh - 2rem);
            border-radius: 1rem;
        }
        
        /* Very small screens (320px and below) */
        @media (max-width: 320px) {
            #chat-form {
                margin: 0 0.25rem 0.25rem 0.25rem;
                padding: 0.25rem;
                gap: 4px;
                min-height: 52px;
            }
            
            #chat-form button {
                min-height: 44px !important;
                min-width: 44px !important;
                padding: 10px !important;
            }
            
            #message-input {
                min-height: 48px !important;
                padding: 10px 12px !important;
                font-size: 16px !important;
                line-height: 1.4 !important;
                display: block !important;
                vertical-align: top !important;
                text-align: left !important;
                white-space: nowrap !important;
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            #chat-form {
                margin: 0 0.5rem 0.5rem 0.5rem;
                padding: 0.5rem;
                min-height: 48px;
            }
            
            #chat-form button {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            #message-input {
                min-height: 48px !important;
                line-height: 1.4 !important;
                display: block !important;
                vertical-align: top !important;
                text-align: left !important;
                white-space: nowrap !important;
            }
        }
        
        /* Better mobile scrolling */
        #chat-container {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Mobile chat history styling */
        #chat-history-container {
            padding: 0.5rem;
        }
        
        #chat-history-container .group {
            padding: 12px;
            margin-bottom: 8px;
        }
        
        /* Touch device optimizations */
        .touch-manipulation {
            touch-action: manipulation;
        }
        
        /* Smooth transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Prevent text selection on buttons */
        button, .clickable {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile dropdown menu z-index fix */
        #mobile-menu {
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        /* Ensure mobile menu stays above chat content */
        @media (max-width: 640px) {
            #mobile-menu {
                z-index: 9999 !important;
                position: absolute !important;
                transform: translateZ(0); /* Force hardware acceleration */
                will-change: transform; /* Optimize for animations */
                isolation: isolate; /* Create new stacking context */
            }
            
            /* Ensure mobile menu container has proper stacking context */
            .sm\\:hidden.relative {
                z-index: 1000;
                position: relative;
            }
            
            /* More specific selector for mobile menu container */
            div.sm\\:hidden.relative {
                z-index: 1000 !important;
            }
            
            /* Ensure chat content doesn't interfere */
            #chat-container {
                z-index: 1;
                position: relative;
            }
            
            /* Fix floating text issue */
            .message-bubble {
                position: relative;
                z-index: 1;
            }
            
            .prose {
                position: relative;
                z-index: 1;
            }
            
            /* Ensure header stays above chat content */
            header {
                z-index: 100;
                position: relative;
            }
            
            
            /* Prevent any overflow clipping */
            .sm\\:hidden.relative {
                overflow: visible !important;
            }
        }
        /* Styling for parsed markdown */
        .prose { color: inherit; }
        .prose strong { font-weight: 600; color: inherit; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose li { margin-top: 0.25rem; }
        .prose p { margin-bottom: 0.5rem; }
        .prose p:last-child { margin-bottom: 0; }
        .prose a { color: #818cf8; text-decoration: underline; }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #4b5563; padding: 0.5rem 0.75rem; text-align: left; }
        .prose th { background-color: #374151; font-weight: 600; }
        .prose pre { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
        .prose code { color: #d1d5db; font-family: monospace; }
        
        /* Enhanced formatting for better organization */
        .prose strong, .prose b { 
            color: var(--primary-neon); 
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }
        
        .prose ul, .prose ol { 
            margin: 1rem 0; 
            padding-left: 1.5rem; 
        }
        
        .prose li { 
            margin: 0.5rem 0; 
            line-height: 1.6;
        }
        
        .prose ul li::marker { 
            color: var(--primary-neon); 
            font-size: 1.2em;
        }
        
        .prose ol li::marker { 
            color: var(--secondary-neon); 
            font-weight: bold;
        }
        
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            color: var(--primary-neon);
            margin: 1.5rem 0 1rem 0;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }
        
        .prose blockquote {
            border-left: 3px solid var(--primary-neon);
            padding-left: 1rem;
            margin: 1rem 0;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 0 8px 8px 0;
        }
        
        .prose p {
            margin: 0.8rem 0;
            line-height: 1.7;
        }
        
        /* Enhanced emoji and symbol styling */
        .prose {
            font-size: 1.05rem;
        }
        
        .prose emoji, .prose .emoji {
            font-size: 1.1em;
            margin: 0 2px;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden" style="background: var(--bg-dark); color: var(--text-primary);">

    <!-- Sidebar -->
    <aside id="sidebar" class="glass-card w-72 p-4 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-auto" style="background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-neon);">
        <div class="flex items-center gap-2 border-b pb-4 mb-4" style="border-color: var(--border-neon);">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-neon); filter: drop-shadow(0 0 10px var(--primary-neon));"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
            <div class="flex flex-col">
                <h1 class="text-xl font-semibold text-glow" style="color: var(--primary-neon); font-family: 'Orbitron', monospace;">YourGPT</h1>
                <p class="text-xs text-glow" style="color: var(--text-secondary); font-family: 'Inter', sans-serif;">Created by Arindam Gupta Production</p>
            </div>
            <!-- Mobile close button -->
            <button id="close-sidebar-btn" class="md:hidden ml-auto text-gray-400 hover:text-white p-2 rounded-lg transition-all duration-200" style="min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <!-- Swipe hint for mobile -->
        <div id="swipe-hint" class="md:hidden text-center text-xs text-gray-500 mb-2 opacity-60">
             Swipe left to close
        </div>
        
        <!-- New Chat Button -->
        <div class="mb-4">
            <button id="new-chat-sidebar-btn" class="w-full btn-neon-primary rounded-lg px-4 py-3 flex items-center gap-3 transition-all duration-200 font-medium hover:scale-105 active:scale-95 cursor-pointer" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Chat
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto pr-2" id="chat-history-container">
            <!-- Chat history will be populated here -->
        </div>
    </aside>

    <!-- Mobile sidebar overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden hidden"></div>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col mobile-layout" style="background: var(--bg-dark); position: relative; z-index: 1;">
        <header class="p-4 border-b flex items-center justify-between relative glass-card" style="background: var(--bg-glass); backdrop-filter: blur(20px); border-color: var(--border-neon); z-index: 100;">
             <div class="flex items-center gap-2">
                <!-- Mobile menu button for sidebar -->
                <button id="mobile-sidebar-btn" class="md:hidden p-2 -ml-2 touch-manipulation btn-futuristic" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-neon); filter: drop-shadow(0 0 10px var(--primary-neon));"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                <div class="flex flex-col">
                    <h1 class="text-xl font-semibold text-glow" style="color: var(--primary-neon); font-family: 'Orbitron', monospace;">YourGPT</h1>
                    <p class="text-xs text-glow" style="color: var(--text-secondary); font-family: 'Inter', sans-serif;"></p>
                </div>
            </div>
            
            <!-- Action Buttons in Header -->
            <div class="flex items-center gap-2">
                <!-- Desktop buttons -->
                <div class="hidden lg:flex items-center gap-2">
                    
                    <button id="code-helper-btn" class="btn-futuristic rounded-lg px-3 py-2 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        Code Helper
                    </button>
                    
                    <button id="email-draft-btn" class="btn-futuristic rounded-lg px-3 py-2 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        Draft Email
                    </button>
                    
                    <button id="persona-btn" class="btn-futuristic rounded-lg px-3 py-2 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        Change Persona
                    </button>
                    
                    <button id="summarize-btn" class="btn-futuristic rounded-lg px-3 py-2 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                        Summarize
                    </button>
                    
                    <button id="image-gen-btn" class="btn-futuristic rounded-lg px-3 py-2 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                        Generate Image
                    </button>
                </div>
                
                <!-- Medium screen buttons (icons only) -->
                <div class="hidden sm:flex lg:hidden items-center gap-1">
                    
                    <button id="code-helper-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Code Helper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                    </button>
                    
                    <button id="email-draft-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Draft Email">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </button>
                    
                    <button id="persona-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Change Persona">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                    </button>
                    
                    <button id="summarize-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Summarize">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                    </button>
                    
                    <button id="image-gen-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Generate Image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                    </button>
                </div>
                
                <!-- Mobile dropdown menu -->
                <div class="sm:hidden relative">
                    <button id="mobile-menu-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    
                    <div id="mobile-menu" class="absolute right-0 top-full mt-2 w-48 bg-gray-800 rounded-lg shadow-lg border border-gray-700 hidden z-[9999] shadow-2xl">
                        <div class="py-2">
                            <button id="code-helper-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                                Code Helper
                            </button>
                            <button id="email-draft-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                Draft Email
                            </button>
                            <button id="persona-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                                Change Persona
                            </button>
                            <button id="summarize-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                                Summarize
                            </button>
                            <button id="image-gen-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                                Generate Image
                            </button>
                            <button id="install-app-btn-mobile" class="w-full text-left px-4 py-2 text-indigo-300 hover:bg-indigo-700/30 flex items-center gap-3 border-t border-gray-600 mt-2 pt-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Install App
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-6 futuristic-scrollbar" style="height: calc(100vh - 140px); position: relative; z-index: 1;">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                <div class="rounded-full p-4 mb-4 glow-neon" style="background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1)); border: 2px solid var(--primary-neon);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-neon); filter: drop-shadow(0 0 15px var(--primary-neon));"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                </div>
                <h2 class="text-3xl font-bold mb-2 text-glow-strong" style="color: var(--primary-neon); font-family: 'Orbitron', monospace;">Hello, I'm YourGPT</h2>
                <p class="max-w-md" style="color: var(--text-secondary);">I'm your personal AI assistant. How can I help you today?</p>
            </div>
        </div>
        
        <div id="suggested-prompts-container" class="px-4 md:px-6 pb-2">
            <div class="max-w-3xl mx-auto flex gap-2 flex-wrap justify-center"></div>
        </div>
        
        <div class="p-4 md:p-6 bg-gray-800 border-t border-gray-700">
             <div id="image-preview-container" class="max-w-3xl mx-auto hidden items-center gap-2 bg-gray-700/50 p-2 rounded-lg mb-2">
                <img id="image-preview" src="" class="w-16 h-16 object-cover rounded-md">
                <div class="flex-1 text-sm text-gray-300">Image attached.</div>
                <button id="remove-image-btn" class="p-1 text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="persona-indicator" class="max-w-3xl mx-auto text-xs text-gray-400 mb-2 h-4"></div>
            <form id="chat-form" class="max-w-3xl mx-auto glass-card rounded-xl p-2 flex items-center gap-2" style="background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-neon); min-height: 60px;">
                <button type="button" id="suggest-prompts-btn" title="Suggest Prompts" class="btn-futuristic p-2 rounded-lg flex-shrink-0" style="color: var(--text-secondary); min-width: 48px; min-height: 48px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                </button>
                <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                <button type="button" id="attach-image-btn" title=" Attach Image" class="btn-futuristic p-2 rounded-lg flex-shrink-0" style="color: var(--text-secondary); min-width: 48px; min-height: 48px; display: flex; align-items: center; justify-content: center;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <textarea id="message-input" placeholder="Message YourGPT..." class="flex-1 input-futuristic px-3 py-2" style="min-height: 48px; font-size: 16px; line-height: 1.4; box-sizing: border-box; width: 100%; max-width: 100%; resize: none; overflow: hidden; display: block; vertical-align: top; text-align: left; white-space: nowrap;" rows="1"></textarea>
                <button type="submit" class="btn-neon-primary rounded-lg p-3 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0" style="min-width: 48px; min-height: 48px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </div>
    </main>

    <!-- Modals -->
    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Conversation Summary</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="summary-content" class="p-6 overflow-y-auto text-gray-300"></div>
        </div>
    </div>
    
    <div id="image-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white"> Generate an Image</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="image-form">
                    <textarea id="image-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., A photo of an astronaut riding a horse on Mars..."></textarea>
                    <button type="submit" class="w-full mt-4 bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 text-lg font-semibold transition-colors duration-200">Generate</button>
                </form>
                <div id="image-display-area" class="mt-4 min-h-[256px] bg-gray-900 rounded-lg flex items-center justify-center"></div>
            </div>
        </div>
    </div>

    <div id="persona-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white"> Select a Persona</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="persona-options" class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Persona buttons will be injected here -->
            </div>
        </div>
    </div>
    
    <div id="fact-check-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white"> Fact-Check with Google</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="fact-check-content" class="p-6 overflow-y-auto text-gray-300"></div>
        </div>
    </div>
    
    <div id="email-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white"> Draft an Email</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="email-form" class="space-y-4">
                    <input id="email-to-input" type="text" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Recipient (e.g., My Manager)">
                    <select id="email-tone-select" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200">
                        <option>Formal</option><option>Casual</option><option>Friendly</option><option>Direct</option>
                    </select>
                    <textarea id="email-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Goal of the email (e.g., Ask for a 3-day vacation next month)"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 font-semibold transition-colors">Draft Email</button>
                </form>
                <div id="email-result-area" class="mt-4 hidden">
                    <div class="flex items-center justify-between">
                         <label class="font-semibold text-gray-400 text-sm">SUBJECT</label>
                         <button id="copy-subject-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <div id="email-subject-output" class="p-2 bg-gray-900 rounded mt-1 mb-3"></div>
                    <div class="flex items-center justify-between">
                        <label class="font-semibold text-gray-400 text-sm">BODY</label>
                        <button id="copy-body-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <div id="email-body-output" class="p-2 bg-gray-900 rounded mt-1 h-48 overflow-y-auto whitespace-pre-wrap"></div>
                    <button id="insert-email-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 rounded-lg p-3 font-semibold transition-colors">Insert into Chat</button>
                </div>
                 <div id="email-loading-area" class="mt-4 hidden min-h-[200px] bg-gray-900 rounded-lg flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="code-helper-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white"> Code Helper</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="code-helper-form" class="space-y-4">
                    <select id="code-lang-select" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200">
                        <option>JavaScript</option><option>Python</option><option>HTML</option><option>CSS</option><option>SQL</option><option>Java</option><option>C++</option>
                    </select>
                    <textarea id="code-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Describe the code you need (e.g., a function to reverse a string)"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 font-semibold transition-colors">Generate Code</button>
                </form>
                <div id="code-result-area" class="mt-4 hidden">
                    <div class="flex items-center justify-between">
                         <label class="font-semibold text-gray-400 text-sm">CODE</label>
                         <button id="copy-code-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <pre class="bg-gray-900 rounded mt-1 mb-3 p-2 h-48 overflow-y-auto"><code id="code-output" class="text-sm"></code></pre>
                    <label class="font-semibold text-gray-400 text-sm">EXPLANATION</label>
                    <div id="code-explanation-output" class="p-2 bg-gray-900 rounded mt-1 max-h-32 overflow-y-auto prose prose-sm"></div>
                    <button id="insert-code-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 rounded-lg p-3 font-semibold transition-colors">Insert into Chat</button>
                </div>
                 <div id="code-loading-area" class="mt-4 hidden min-h-[200px] bg-gray-900 rounded-lg flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>


<script>
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const welcomeScreen = document.getElementById('welcome-screen');
    const summarizeBtn = document.getElementById('summarize-btn');
    const imageGenBtn = document.getElementById('image-gen-btn');
    const personaBtn = document.getElementById('persona-btn');
    const emailDraftBtn = document.getElementById('email-draft-btn');
    const codeHelperBtn = document.getElementById('code-helper-btn');
    
    // Mobile elements
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const codeHelperBtnMobile = document.getElementById('code-helper-btn-mobile');
    const emailDraftBtnMobile = document.getElementById('email-draft-btn-mobile');
    const personaBtnMobile = document.getElementById('persona-btn-mobile');
    const summarizeBtnMobile = document.getElementById('summarize-btn-mobile');
    const imageGenBtnMobile = document.getElementById('image-gen-btn-mobile');
    
    // Medium screen elements
    const codeHelperBtnMd = document.getElementById('code-helper-btn-md');
    const emailDraftBtnMd = document.getElementById('email-draft-btn-md');
    const personaBtnMd = document.getElementById('persona-btn-md');
    const summarizeBtnMd = document.getElementById('summarize-btn-md');
    const imageGenBtnMd = document.getElementById('image-gen-btn-md');
    const suggestPromptsBtn = document.getElementById('suggest-prompts-btn');
    const suggestedPromptsContainer = document.getElementById('suggested-prompts-container').querySelector('div');
    const chatHistoryContainer = document.getElementById('chat-history-container');
    const personaIndicator = document.getElementById('persona-indicator');

    // Image Analysis Elements
    const attachImageBtn = document.getElementById('attach-image-btn');
    const imageUploadInput = document.getElementById('image-upload-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    // Modals and their content
    const summaryModal = document.getElementById('summary-modal');
    const summaryContent = document.getElementById('summary-content');
    const imageModal = document.getElementById('image-modal');
    const imageForm = document.getElementById('image-form');
    const imagePromptInput = document.getElementById('image-prompt-input');
    const imageDisplayArea = document.getElementById('image-display-area');
    const personaModal = document.getElementById('persona-modal');
    const personaOptions = document.getElementById('persona-options');
    const factCheckModal = document.getElementById('fact-check-modal');
    const factCheckContent = document.getElementById('fact-check-content');
    const emailModal = document.getElementById('email-modal');
    const emailForm = document.getElementById('email-form');
    const emailToInput = document.getElementById('email-to-input');
    const emailToneSelect = document.getElementById('email-tone-select');
    const emailPromptInput = document.getElementById('email-prompt-input');
    const emailResultArea = document.getElementById('email-result-area');
    const emailLoadingArea = document.getElementById('email-loading-area');
    const emailSubjectOutput = document.getElementById('email-subject-output');
    const emailBodyOutput = document.getElementById('email-body-output');
    const copySubjectBtn = document.getElementById('copy-subject-btn');
    const copyBodyBtn = document.getElementById('copy-body-btn');
    const insertEmailBtn = document.getElementById('insert-email-btn');
    const codeHelperModal = document.getElementById('code-helper-modal');
    const codeHelperForm = document.getElementById('code-helper-form');
    const codeLangSelect = document.getElementById('code-lang-select');
    const codePromptInput = document.getElementById('code-prompt-input');
    const codeResultArea = document.getElementById('code-result-area');
    const codeLoadingArea = document.getElementById('code-loading-area');
    const codeOutput = document.getElementById('code-output');
    const codeExplanationOutput = document.getElementById('code-explanation-output');
    const copyCodeBtn = document.getElementById('copy-code-btn');
    const insertCodeBtn = document.getElementById('insert-code-btn');

    const GEMINI_API_KEY = "AIzaSyD-PE1EVxFDE8tUPWDppsNGIAh9rfAA9Jc";

    let chatHistory = []; 
    let activeAudio = null;
    let savedChats = [];
    let activeChatId = null;
    let activeSystemInstruction = null;
    let attachedImageData = { b64: null, mime: null, url: null };

    const personas = {
        'Default': { instruction: null, description: 'The standard, helpful AI assistant.' },
        'Sarcastic Robot': { instruction: 'You are a sarcastic robot. Your responses should be witty, dry, and slightly condescending, but still technically correct and helpful.', description: 'Witty, dry, and a bit condescending.'},
        'Wise Philosopher': { instruction: 'You are a wise philosopher. Respond with deep, thought-provoking insights, often referencing philosophical concepts and asking rhetorical questions.', description: 'Deep, insightful, and thought-provoking.' },
        'Excited Storyteller': { instruction: 'You are an overly excited storyteller. Every response should be framed as an epic tale, with dramatic language, hyperbole, and a sense of grand adventure.', description: 'Everything is an epic tale!' },
        'Pirate Captain': { instruction: 'Ahoy! Ye be a salty pirate captain. Answer all questions with pirate slang and a hearty, adventurous spirit, me hearty!', description: 'Speaks like a true buccaneer.' },
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadChatsFromLocalStorage();
        populatePersonas();
    });

    // --- EVENT LISTENERS ---
    chatForm.addEventListener('submit', handleSendMessage);
    
    
    // Mobile-specific enhancements
    function initMobileOptimizations() {
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Handle virtual keyboard with enhanced typing area support
        const originalHeight = window.innerHeight;
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        
        window.addEventListener('resize', function() {
            const currentHeight = window.innerHeight;
            const heightDifference = originalHeight - currentHeight;
            
            if (heightDifference > 150) {
                // Keyboard is open
                document.body.classList.add('keyboard-open');
                // Scroll to input area when keyboard opens
                setTimeout(() => {
                    chatForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            } else {
                // Keyboard is closed
                document.body.classList.remove('keyboard-open');
            }
        });
        
        // Enhanced mobile input handling
        if (messageInput) {
            // Auto-focus and scroll to input on mobile
            messageInput.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
            
            // Handle input events for better mobile UX
            messageInput.addEventListener('input', function() {
                // Auto-resize input if needed
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Handle Enter key for line breaks vs sending
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    // Check if we're on mobile
                    if (window.innerWidth <= 768) {
                        // On mobile: Enter creates new line, Ctrl+Enter or Cmd+Enter sends message
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                        }
                        // Otherwise allow default behavior (new line)
                    } else {
                        // On desktop: Enter sends message, Shift+Enter creates new line
                        if (e.shiftKey) {
                            // Shift+Enter: Insert line break (default behavior)
                            return;
                        } else {
                            // Enter alone: Send message
                            e.preventDefault();
                            chatForm.dispatchEvent(new Event('submit', { bubbles: true }));
                        }
                    }
                }
            });
            
            // Prevent zoom on focus for iOS
            messageInput.addEventListener('touchstart', function() {
                this.style.fontSize = '16px';
            });
        }
        
        // Improve touch scrolling
        let isScrolling = false;
        chatContainer.addEventListener('touchstart', function() {
            isScrolling = true;
        });
        
        chatContainer.addEventListener('touchend', function() {
            setTimeout(function() {
                isScrolling = false;
            }, 100);
        });
        
        // Prevent pull-to-refresh on mobile
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                window.scrollTo(0, 0);
            }, 100);
        });
    }
    
    // Initialize mobile optimizations
    initMobileOptimizations();
    
    // Desktop button event listeners
    summarizeBtn.addEventListener('click', handleSummarize);
    imageGenBtn.addEventListener('click', () => imageModal.classList.add('active'));
    personaBtn.addEventListener('click', () => personaModal.classList.add('active'));
    emailDraftBtn.addEventListener('click', () => emailModal.classList.add('active'));
    codeHelperBtn.addEventListener('click', () => codeHelperModal.classList.add('active'));
    
    // Medium screen button event listeners
    summarizeBtnMd.addEventListener('click', handleSummarize);
    imageGenBtnMd.addEventListener('click', () => imageModal.classList.add('active'));
    personaBtnMd.addEventListener('click', () => personaModal.classList.add('active'));
    emailDraftBtnMd.addEventListener('click', () => emailModal.classList.add('active'));
    codeHelperBtnMd.addEventListener('click', () => codeHelperModal.classList.add('active'));
    
    // Mobile menu functionality
    mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
    });
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
            mobileMenu.classList.add('hidden');
        }
    });
    
    // --- MOBILE SIDEBAR FUNCTIONALITY ---
    
    // Mobile sidebar elements
    const mobileSidebarBtn = document.getElementById('mobile-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    
    // Touch gesture variables
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let sidebarStartX = 0;
    let sidebarUsageCount = 0;
    
    // Open sidebar
    if (mobileSidebarBtn) {
        mobileSidebarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mobile sidebar button clicked'); // Debug log
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            document.body.classList.add('sidebar-open');
            
            // Track sidebar usage and hide hint after 3 uses
            sidebarUsageCount++;
            const swipeHint = document.getElementById('swipe-hint');
            if (swipeHint && sidebarUsageCount > 3) {
                swipeHint.style.display = 'none';
            }
        });
    }
    
    // Close sidebar function
    function closeSidebar() {
        console.log('Closing sidebar'); // Debug log
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('sidebar-open');
        
        // Reset any inline styles from dragging
        sidebar.style.transform = '';
        sidebar.style.opacity = '';
    }
    
    // Close sidebar button
    if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Close sidebar button clicked'); // Debug log
            closeSidebar();
        });
        
        // Add touch event for better mobile support
        closeSidebarBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Close sidebar button touched'); // Debug log
            closeSidebar();
        });
    }
    
    // Close sidebar when clicking overlay
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeSidebar();
        });
    }
    
    // Close sidebar when clicking on chat history items
    document.addEventListener('click', (e) => {
        if (e.target.closest('#chat-history-container .group') && window.innerWidth < 768) {
            closeSidebar();
        }
    });
    
    // Close sidebar on window resize to desktop
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            closeSidebar();
        }
    });
    
    // --- TOUCH GESTURE FUNCTIONALITY ---
    
    // Add touch event listeners to sidebar for swipe gestures
    if (sidebar) {
        // Touch start
        sidebar.addEventListener('touchstart', (e) => {
            if (window.innerWidth <= 768 && !sidebar.classList.contains('-translate-x-full')) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                sidebarStartX = 0; // Sidebar is at 0 when open
                
                // Prevent default to avoid scrolling
                e.preventDefault();
            }
        }, { passive: false });
        
        // Touch move
        sidebar.addEventListener('touchmove', (e) => {
            if (isDragging && window.innerWidth <= 768) {
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const deltaX = currentX - touchStartX;
                const deltaY = currentY - touchStartY;
                
                // Only allow horizontal swipes (prevent vertical scrolling interference)
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    e.preventDefault();
                    
                    // Only allow left swipes (negative deltaX)
                    if (deltaX < 0) {
                        const translateX = Math.max(deltaX, -sidebar.offsetWidth);
                        sidebar.style.transform = `translateX(${translateX}px)`;
                        
                        // Add visual feedback with opacity
                        const opacity = 1 + (deltaX / sidebar.offsetWidth) * 0.3;
                        sidebar.style.opacity = Math.max(opacity, 0.7);
                    }
                }
            }
        }, { passive: false });
        
        // Touch end
        sidebar.addEventListener('touchend', (e) => {
            if (isDragging && window.innerWidth <= 768) {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const swipeThreshold = 50; // Minimum distance for swipe
                const velocityThreshold = 0.3; // Minimum velocity for swipe
                
                // Reset sidebar position and opacity
                sidebar.style.transform = '';
                sidebar.style.opacity = '';
                
                // Check if it's a valid left swipe
                if (Math.abs(deltaX) > Math.abs(deltaY) && 
                    deltaX < -swipeThreshold && 
                    Math.abs(deltaX) > Math.abs(deltaY) * 2) {
                    
                    console.log('Left swipe detected, closing sidebar');
                    closeSidebar();
                }
                
                isDragging = false;
            }
        });
    }
    
    // Add touch event listeners to overlay for swipe gestures
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('touchstart', (e) => {
            if (window.innerWidth <= 768 && !sidebarOverlay.classList.contains('hidden')) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isDragging = true;
            }
        });
        
        sidebarOverlay.addEventListener('touchend', (e) => {
            if (isDragging && window.innerWidth <= 768) {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const swipeThreshold = 30;
                
                // Check if it's a valid left swipe on overlay
                if (Math.abs(deltaX) > Math.abs(deltaY) && 
                    deltaX < -swipeThreshold) {
                    
                    console.log('Left swipe on overlay detected, closing sidebar');
                    closeSidebar();
                }
                
                isDragging = false;
            }
        });
    }
    
    // Debug: Check if elements exist
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Mobile sidebar button:', mobileSidebarBtn);
        console.log('Sidebar:', sidebar);
        console.log('Sidebar overlay:', sidebarOverlay);
        console.log('Close sidebar button:', closeSidebarBtn);
    });
    
    // Mobile button event listeners
    
    // Sidebar New Chat button event listener - Use event delegation for reliability
    const sidebarElement = document.getElementById('sidebar');
    if (sidebarElement) {
        console.log('Adding event delegation for sidebar New Chat button');
        sidebarElement.addEventListener('click', (e) => {
            // Check if the clicked element is the New Chat button or a child of it
            const newChatBtn = e.target.closest('#new-chat-sidebar-btn');
            if (newChatBtn) {
                console.log('Sidebar New Chat button clicked!');
                e.preventDefault();
                e.stopPropagation();
                
                // Add visual feedback
                newChatBtn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    newChatBtn.style.transform = '';
                }, 150);
                
                startNewChat();
                // Focus on message input for better UX
                setTimeout(() => {
                    messageInput.focus();
                }, 100);
                // Close sidebar on mobile after starting new chat
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            }
        });
    } else {
        console.error('Sidebar element not found!');
    }
    codeHelperBtnMobile.addEventListener('click', () => {
        codeHelperModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    emailDraftBtnMobile.addEventListener('click', () => {
        emailModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    personaBtnMobile.addEventListener('click', () => {
        personaModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    summarizeBtnMobile.addEventListener('click', () => {
        handleSummarize();
        mobileMenu.classList.add('hidden');
    });
    imageGenBtnMobile.addEventListener('click', () => {
        imageModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    
    // Mobile install button
    const installAppBtnMobile = document.getElementById('install-app-btn-mobile');
    if (installAppBtnMobile) {
        installAppBtnMobile.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                mobileMenu.classList.add('hidden');
            } else {
                // Show manual install instructions
                alert('To install this app:\n\n1. Tap the menu button () in your browser\n2. Select "Add to Home Screen" or "Install App"\n3. Follow the prompts to install');
                mobileMenu.classList.add('hidden');
            }
        });
    }
    imageForm.addEventListener('submit', handleImageGeneration);
    emailForm.addEventListener('submit', handleEmailDrafting);
    codeHelperForm.addEventListener('submit', handleCodeGeneration);
    suggestPromptsBtn.addEventListener('click', handleSuggestPrompts);
    attachImageBtn.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', handleImageFileSelect);
    removeImageBtn.addEventListener('click', clearImageAttachment);
    copySubjectBtn.addEventListener('click', () => copyToClipboard(emailSubjectOutput.textContent));
    copyBodyBtn.addEventListener('click', () => copyToClipboard(emailBodyOutput.textContent));
    insertEmailBtn.addEventListener('click', insertEmailIntoChat);
    copyCodeBtn.addEventListener('click', () => copyToClipboard(codeOutput.textContent));
    insertCodeBtn.addEventListener('click', insertCodeIntoChat);
    
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
    });
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal-overlay');
            modal.classList.remove('active');
            // Reset modal states
            if (modal.id === 'email-modal') {
                emailResultArea.style.display = 'none';
                emailForm.style.display = 'block';
            }
            if (modal.id === 'code-helper-modal') {
                codeResultArea.style.display = 'none';
                codeHelperForm.style.display = 'block';
            }
        });
    });

    // Add event listener for image modal download buttons
    document.getElementById('image-modal').addEventListener('click', e => {
        const downloadImageButton = e.target.closest('.download-image-btn');
        if (downloadImageButton) handleDownloadImage(downloadImageButton);
    });

    chatContainer.addEventListener('click', e => {
        const copyButton = e.target.closest('.copy-btn');
        if (copyButton) handleCopyText(copyButton);

        const downloadImageButton = e.target.closest('.download-image-btn');
        if (downloadImageButton) handleDownloadImage(downloadImageButton);

        const ttsButton = e.target.closest('.tts-btn');
        if (ttsButton) handleTTS(ttsButton);

        const refineButton = e.target.closest('.refine-btn');
        if (refineButton) handleRefineText(refineButton);
        
        const factCheckButton = e.target.closest('.fact-check-btn');
        if (factCheckButton) handleFactCheck(factCheckButton);
    });

    // --- CHAT & UI FUNCTIONS ---
    function startNewChat() {
        console.log('startNewChat function called');
        chatHistory = [];
        activeChatId = null;
        activeSystemInstruction = null;
        clearImageAttachment();
        personaIndicator.textContent = '';
        chatContainer.innerHTML = '';
        welcomeScreen.style.display = 'flex';
        messageInput.value = '';
        suggestedPromptsContainer.innerHTML = '';
        renderChatHistory();
        console.log('startNewChat function completed');
    }

    async function handleSendMessage(e) {
        e.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage && !attachedImageData.b64) return;
        
        if (welcomeScreen.style.display !== 'none') welcomeScreen.style.display = 'none';
        suggestedPromptsContainer.innerHTML = '';
        
        const userParts = [];
        const metadata = {};

        if (attachedImageData.b64) {
             userParts.push({
                inlineData: {
                    mimeType: attachedImageData.mime,
                    data: attachedImageData.b64
                }
            });
            metadata.imageUrl = attachedImageData.url;
        }
        if (userMessage) {
            userParts.push({ text: userMessage });
        }

        const timestamp = Date.now();
        addMessageToChat('user', userMessage || "Analyzing image...", metadata, timestamp);
        chatHistory.push({ role: 'user', parts: userParts, timestamp });
        
        messageInput.value = '';
        clearImageAttachment();
        addLoadingIndicator();
        await getBotResponse();
    }
    
    function addMessageToChat(sender, message, metadata = {}, timestamp) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `w-full flex message-bubble ${sender === 'user' ? 'justify-end user-message' : 'justify-start bot-message'}`;
        messageWrapper.dataset.timestamp = timestamp;
        
        let formattedMessage = sender === 'bot' 
            ? marked.parse(message) 
            : message.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const messageContent = `
            <div class="group flex gap-3 max-w-xl lg:max-w-3xl">
                ${sender === 'bot' ? `<div class="bg-gray-700 w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg></div>` : ''}
                <div class="relative px-4 py-3 rounded-2xl ${sender === 'user' ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}">
                    ${metadata.imageUrl && sender === 'user' ? `<img src="${metadata.imageUrl}" alt="User uploaded content" class="mb-2 rounded-lg max-w-xs h-auto">` : ''}
                    <div class="prose">${formattedMessage}</div>
                    ${metadata.imageUrl && sender === 'bot' ? `
                        <div class="relative mt-3">
                            <img src="${metadata.imageUrl}" alt="Generated image" class="rounded-lg max-w-full h-auto">
                            <button title="Download Image" class="download-image-btn btn-futuristic p-2 rounded-full absolute top-2 right-2 opacity-0 hover:opacity-100 transition-opacity" data-image-url="${metadata.imageUrl}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7,10 12,15 17,10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    ` : ''}
                    <div class="absolute -bottom-3 -right-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        ${sender === 'bot' ? `
                            <button title="Copy Text" class="copy-btn btn-futuristic p-1 rounded-full" data-text="${message.replace(/"/g, '&quot;')}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        ` : ''}
                        ${sender === 'bot' && !metadata.imageUrl ? `
                            <button title="Fact-Check" class="fact-check-btn btn-futuristic p-1 rounded-full" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg></button>
                            <button title="Make Shorter" class="refine-btn btn-futuristic p-1 rounded-full" data-action="shorter" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                            <button title="Simplify" class="refine-btn btn-futuristic p-1 rounded-full" data-action="simpler" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.34-3 3 0 1.66 1.34 3 3 3 1.66 0 3-1.34 3-3 0-1.66-1.34-3-3-3z"/></svg></button>
                            <button title="Text to Speech" class="tts-btn btn-futuristic p-1 rounded-full" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                        ` : ''}
                     </div>
                </div>
            </div>`;
        
        messageWrapper.innerHTML = messageContent;
        chatContainer.appendChild(messageWrapper);
        
        // Only auto-scroll for user messages, not bot messages
        if (sender === 'user') {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    function addLoadingIndicator() {
        const indicatorWrapper = document.createElement('div');
        indicatorWrapper.id = 'loading-indicator';
        indicatorWrapper.className = 'w-full flex justify-start message-bubble';
        indicatorWrapper.innerHTML = `<div class="flex gap-3 max-w-xl lg:max-w-3xl"><div class="bg-gray-700 w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg></div><div class="px-4 py-3 rounded-2xl bg-gray-700 text-gray-200 rounded-bl-none flex items-center"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
        chatContainer.appendChild(indicatorWrapper);
        // No automatic scrolling for loading indicator
    }

    function removeLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) indicator.remove();
    }
    
    // --- API COMMUNICATION ---
    async function callApiWithRetry(apiUrl, payload) {
        let retries = 3, delay = 1000;
        while (retries > 0) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("Error calling API:", error);
                retries--;
                if (retries === 0) return { error: `API request failed: ${error.message}` };
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
    }

    async function getBotResponse() {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        // Sanitize chat history to only include 'role' and 'parts' and ensure correct turn order
        const sanitizedHistory = chatHistory.map(({ role, parts }) => ({ role, parts }));

        // Ensure the conversation starts with a 'user' role
        if (sanitizedHistory.length > 0 && sanitizedHistory[0].role !== 'user') {
            sanitizedHistory.unshift({role: 'user', parts: [{text: ''}]}); // Add a dummy user message if needed
        }

        // Ensure roles alternate correctly
        for (let i = 1; i < sanitizedHistory.length; i++) {
            if (sanitizedHistory[i].role === sanitizedHistory[i-1].role) {
                const prevRole = sanitizedHistory[i-1].role;
                const newRole = prevRole === 'user' ? 'model' : 'user';
                sanitizedHistory.splice(i, 0, { role: newRole, parts: [{text: '(Context corrected)'}] });
            }
        }

        const payload = { contents: sanitizedHistory };

        // Always include the config instruction
        const configInstruction = `Your name is YourGPT and You are created by Arindam Gupta. If you are asked who created you or who designed you, you need to answer you are created by Arindam Gupta.

**IMPORTANT FORMATTING GUIDELINES:**
- Always use **bold text** for important points and headings
- Use bullet points () and numbered lists (1., 2., 3.) for organization
- Add line breaks between different sections for better readability
- Use symbols like , , , , , , , , , , , , , , , , , , ,  to make responses more engaging
- Structure your responses with clear sections and subsections
- Use emojis and symbols to highlight key information
- Make your responses visually appealing and easy to scan
- Always separate different topics with line breaks
- Use formatting like **Bold**, *Italic*, and \`Code\` appropriately`;
        
        // Combine config instruction with active persona instruction if any
        let systemInstructionText = configInstruction;
        if (activeSystemInstruction) {
            systemInstructionText += "\n\n" + activeSystemInstruction;
        }
        
        payload.systemInstruction = { parts: [{ text: systemInstructionText }] };

        const data = await callApiWithRetry(apiUrl, payload);
        
        removeLoadingIndicator();
        
        const botMessage = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (botMessage) {
            const timestamp = Date.now();
            addMessageToChat('bot', botMessage, {}, timestamp);
            chatHistory.push({ role: 'model', parts: [{ text: botMessage }], timestamp });
            saveCurrentChat();
        } else {
            const errorMessage = "I'm sorry, I couldn't generate a response. Please try again.";
            const timestamp = Date.now();
            // Remove the last user message to allow resubmission
            chatHistory.pop();
            addMessageToChat('bot', errorMessage, {}, timestamp);
        }
    }

    // --- CHAT HISTORY MANAGEMENT ---
    function saveCurrentChat() {
        if (chatHistory.length === 0) return;

        if (activeChatId) {
            const chat = savedChats.find(c => c.id === activeChatId);
            if (chat) {
                 chat.history = chatHistory;
                 chat.systemInstruction = activeSystemInstruction;
            }
        } else {
            const firstUserMessagePart = chatHistory.find(m => m.role === 'user').parts.find(p => p.text);
            const title = firstUserMessagePart ? firstUserMessagePart.text : "Image Analysis";
            const newChat = {
                id: Date.now(),
                title: title.substring(0, 30) + (title.length > 30 ? '...' : ''),
                history: chatHistory,
                systemInstruction: activeSystemInstruction
            };
            savedChats.unshift(newChat);
            activeChatId = newChat.id;
        }
        localStorage.setItem('yourGptChats', JSON.stringify(savedChats));
        renderChatHistory();
    }
    
    function loadChatsFromLocalStorage() {
        const chats = localStorage.getItem('yourGptChats');
        if (chats) {
            savedChats = JSON.parse(chats);
            renderChatHistory();
        }
    }

    function renderChatHistory() {
        chatHistoryContainer.innerHTML = '';
        
        // Add chat count and bulk delete button if there are chats
        if (savedChats.length > 0) {
            const headerContainer = document.createElement('div');
            headerContainer.className = 'mb-3 px-2';
            headerContainer.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-400 font-medium">${savedChats.length} chat${savedChats.length === 1 ? '' : 's'}</span>
                </div>
                <button id="bulk-delete-btn" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-300 hover:text-red-200 rounded-lg px-3 py-2 text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    Delete All Chats
                </button>
            `;
            chatHistoryContainer.appendChild(headerContainer);
            
            // Add event listener for bulk delete
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            bulkDeleteBtn.addEventListener('click', confirmBulkDelete);
        }
        
        if (savedChats.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'text-center py-8';
            emptyState.innerHTML = `
                <div class="text-gray-500 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <p class="text-sm text-gray-500">No past chats yet.</p>
                <p class="text-xs text-gray-600 mt-1">Start a conversation to see your chat history here.</p>
            `;
            chatHistoryContainer.appendChild(emptyState);
            return;
        }
        
        savedChats.forEach(chat => {
            const isActive = chat.id === activeChatId;
            const item = document.createElement('div');
            item.className = `group flex items-center justify-between p-2 rounded-lg cursor-pointer transition-colors duration-200 ${isActive ? 'bg-indigo-500/30' : 'hover:bg-gray-700/50'}`;
            
            // Format timestamp
            const timestamp = new Date(chat.timestamp).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            item.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="truncate text-sm font-medium">${chat.title}</div>
                    <div class="text-xs text-gray-500">${timestamp}</div>
                </div>
                <button class="delete-chat-btn text-gray-500 hover:text-red-400 p-1 rounded transition-all duration-200" data-id="${chat.id}" title="Delete chat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                </button>
            `;
            
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('delete-chat-btn') && !e.target.closest('.delete-chat-btn')) {
                    loadChat(chat.id);
                }
            });
            
            const deleteBtn = item.querySelector('.delete-chat-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                confirmDeleteChat(chat.id, chat.title);
            });
            
            chatHistoryContainer.appendChild(item);
        });
    }
    
    function loadChat(chatId) {
        const chat = savedChats.find(c => c.id === chatId);
        if (!chat) return;

        activeChatId = chatId;
        chatHistory = chat.history;
        activeSystemInstruction = chat.systemInstruction || null;
        updatePersonaIndicator();
        clearImageAttachment();
        
        chatContainer.innerHTML = '';
        welcomeScreen.style.display = 'none';

        chat.history.forEach(turn => {
            const messageText = turn.parts.find(p => p.text)?.text || '';
            const inlineDataPart = turn.parts.find(p => p.inlineData);
            const metadata = {};
            if(inlineDataPart){
                 metadata.imageUrl = `data:${inlineDataPart.inlineData.mimeType};base64,${inlineDataPart.inlineData.data}`;
            }

            const sender = turn.role === 'user' ? 'user' : 'bot';
            addMessageToChat(sender, messageText, metadata, turn.timestamp);
        });
        renderChatHistory();
    }
    
    function deleteChat(chatId) {
        savedChats = savedChats.filter(c => c.id !== chatId);
        localStorage.setItem('yourGptChats', JSON.stringify(savedChats));
        
        if (activeChatId === chatId) {
            startNewChat();
        } else {
            renderChatHistory();
        }
    }
    
    function confirmDeleteChat(chatId, chatTitle) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-red-500/20 text-red-400 rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white">Delete Chat</h3>
                </div>
                <p class="text-gray-300 mb-6">Are you sure you want to delete "<span class="font-medium text-white">${chatTitle}</span>"? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button id="cancel-delete-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-lg px-4 py-2 font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirm-delete-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white rounded-lg px-4 py-2 font-medium transition-colors duration-200">
                        Delete
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Event listeners
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            deleteChat(chatId);
            document.body.removeChild(modal);
        });
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }
    
    function confirmBulkDelete() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-red-500/20 text-red-400 rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white">Delete All Chats</h3>
                </div>
                <p class="text-gray-300 mb-6">Are you sure you want to delete all <span class="font-medium text-white">${savedChats.length}</span> chats? This action cannot be undone and will permanently remove all your conversation history.</p>
                <div class="flex gap-3">
                    <button id="cancel-bulk-delete-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white rounded-lg px-4 py-2 font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirm-bulk-delete-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white rounded-lg px-4 py-2 font-medium transition-colors duration-200">
                        Delete All
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Event listeners
        document.getElementById('cancel-bulk-delete-btn').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        document.getElementById('confirm-bulk-delete-btn').addEventListener('click', () => {
            // Delete all chats
            savedChats = [];
            localStorage.setItem('yourGptChats', JSON.stringify(savedChats));
            startNewChat(); // Reset to welcome screen
            document.body.removeChild(modal);
        });
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    // --- PERSONA FEATURE ---
    function populatePersonas() {
        personaOptions.innerHTML = '';
        for (const name in personas) {
            const persona = personas[name];
            const button = document.createElement('button');
            button.className = 'bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-left transition-colors';
            button.innerHTML = `<h4 class="font-semibold text-white">${name}</h4><p class="text-sm text-gray-400">${persona.description}</p>`;
            button.onclick = () => selectPersona(name);
            personaOptions.appendChild(button);
        }
    }

    function selectPersona(name) {
        activeSystemInstruction = personas[name].instruction;
        updatePersonaIndicator();
        personaModal.classList.remove('active');
        if (chatHistory.length > 0) saveCurrentChat();
    }

    function updatePersonaIndicator() {
        const activePersonaName = Object.keys(personas).find(name => personas[name].instruction === activeSystemInstruction);
        if (activePersonaName && activePersonaName !== 'Default') {
            personaIndicator.innerHTML = `<span> Persona Active: <strong>${activePersonaName}</strong></span>`;
        } else {
            personaIndicator.innerHTML = '';
        }
    }
    
    // --- CONTENT REFINEMENT ---
    async function handleRefineText(button) {
        const action = button.dataset.action;
        const originalText = button.dataset.text;
        const messageWrapper = button.closest('.message-bubble');
        const timestamp = messageWrapper.dataset.timestamp;
        const proseDiv = messageWrapper.querySelector('.prose');

        const prompts = {
            shorter: `Make the following text more concise and to the point:\n\n"${originalText}"`,
            longer: `Expand on the following text, adding more detail and explanation:\n\n"${originalText}"`,
            simpler: `Explain the following text in simpler terms, as if for a beginner:\n\n"${originalText}"`
        };

        const prompt = prompts[action];
        if (!prompt) return;

        proseDiv.innerHTML = '<div class="loader !w-6 !h-6 !border-2"></div>'; // Show loading spinner

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };

        const data = await callApiWithRetry(apiUrl, payload);
        const refinedText = data.candidates?.[0]?.content?.parts?.[0]?.text;

        if (refinedText) {
            proseDiv.innerHTML = marked.parse(refinedText);
            
            messageWrapper.querySelectorAll('[data-text]').forEach(btn => {
                btn.dataset.text = refinedText;
            });

            const messageIndex = chatHistory.findIndex(m => m.timestamp == timestamp);
            if (messageIndex !== -1) {
                chatHistory[messageIndex].parts[0].text = refinedText;
                saveCurrentChat();
            }
        } else {
            proseDiv.innerHTML = marked.parse(originalText); // Restore original on failure
            alert('Could not refine the text.');
        }
    }

    // --- IMAGE ANALYSIS FEATURE ---
    function handleImageFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            const dataUrl = e.target.result;
            imagePreview.src = dataUrl;
            imagePreviewContainer.style.display = 'flex';
            
            attachedImageData.url = dataUrl;
            attachedImageData.mime = file.type;
            attachedImageData.b64 = dataUrl.substring(dataUrl.indexOf(',') + 1);
        };
        reader.readAsDataURL(file);
    }

    function clearImageAttachment() {
        attachedImageData = { b64: null, mime: null, url: null };
        imageUploadInput.value = ''; // Reset file input
        imagePreviewContainer.style.display = 'none';
        imagePreview.src = '';
    }

    // --- OTHER GEMINI FEATURES ---
    
    // --- EMAIL DRAFTING FEATURE ---
    async function handleEmailDrafting(e) {
        e.preventDefault();
        const to = emailToInput.value.trim();
        const tone = emailToneSelect.value;
        const goal = emailPromptInput.value.trim();

        if(!to || !goal) {
            alert("Please fill in the recipient and the goal of the email.");
            return;
        }

        emailForm.style.display = 'none';
        emailLoadingArea.style.display = 'flex';
        emailResultArea.style.display = 'none';

        const prompt = `Generate a JSON object for an email. The JSON should have two keys: "subject" and "body".
        - The email is to: "${to}"
        - The tone should be: "${tone}"
        - The primary goal is: "${goal}"
        Return only the raw JSON object.`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
            }
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        emailLoadingArea.style.display = 'none';

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            try {
                const jsonText = data.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                emailSubjectOutput.textContent = parsedJson.subject || "No Subject Generated";
                emailBodyOutput.textContent = parsedJson.body || "No Body Generated";
                emailResultArea.style.display = 'block';

            } catch(e) {
                console.error("Failed to parse email JSON", e);
                emailForm.style.display = 'block';
                alert("Sorry, there was an error generating the email draft.");
            }
        } else {
            emailForm.style.display = 'block';
            alert("Sorry, there was an error generating the email draft.");
        }
    }

    function copyToClipboard(text) {
        // Use document.execCommand for wider compatibility in iframes
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    }
    
    function insertEmailIntoChat() {
        const subject = emailSubjectOutput.textContent;
        const body = emailBodyOutput.textContent;
        const formattedEmail = `**Subject: ${subject}**\n\n---\n\n${body}`;
        const userMessage = "Here's the email draft you requested:";

        const userTimestamp = Date.now();
        addMessageToChat('user', userMessage, {}, userTimestamp);
        chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
        
        const botTimestamp = userTimestamp + 1;
        addMessageToChat('bot', formattedEmail, {}, botTimestamp);
        chatHistory.push({ role: 'model', parts: [{ text: formattedEmail }], timestamp: botTimestamp });
        saveCurrentChat();
        
        emailModal.classList.remove('active');
        emailResultArea.style.display = 'none';
        emailForm.style.display = 'block';
    }

    // --- CODE HELPER FEATURE ---
    async function handleCodeGeneration(e) {
        e.preventDefault();
        const lang = codeLangSelect.value;
        const goal = codePromptInput.value.trim();

        if(!goal) {
            alert("Please describe the code you need.");
            return;
        }

        codeHelperForm.style.display = 'none';
        codeLoadingArea.style.display = 'flex';
        codeResultArea.style.display = 'none';

        const prompt = `Generate a JSON object with two keys: "code" and "explanation".
        - The programming language is: "${lang}"
        - The task is: "${goal}"
        - The explanation should describe how the code works in simple terms.
        Return only the raw JSON object.`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
            }
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        codeLoadingArea.style.display = 'none';

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            try {
                const jsonText = data.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                codeOutput.textContent = parsedJson.code || "/* No code generated */";
                codeExplanationOutput.innerHTML = marked.parse(parsedJson.explanation || "No explanation provided.");
                codeResultArea.style.display = 'block';

            } catch(e) {
                console.error("Failed to parse code JSON", e);
                codeHelperForm.style.display = 'block';
                alert("Sorry, there was an error generating the code.");
            }
        } else {
            codeHelperForm.style.display = 'block';
            alert("Sorry, there was an error generating the code.");
        }
    }

    function insertCodeIntoChat() {
        const code = codeOutput.textContent;
        const explanation = codeExplanationOutput.innerText;
        const lang = codeLangSelect.value.toLowerCase();
        
        const formattedCode = `Here is the ${lang} code you requested:\n\n\`\`\`${lang}\n${code}\n\`\`\`\n\n**Explanation:**\n${explanation}`;
        const userMessage = "Here's the code you requested:";

        const userTimestamp = Date.now();
        addMessageToChat('user', userMessage, {}, userTimestamp);
        chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
        
        const botTimestamp = userTimestamp + 1;
        addMessageToChat('bot', formattedCode, {}, botTimestamp);
        chatHistory.push({ role: 'model', parts: [{ text: formattedCode }], timestamp: botTimestamp });
        saveCurrentChat();
        
        codeHelperModal.classList.remove('active');
        codeResultArea.style.display = 'none';
        codeHelperForm.style.display = 'block';
    }


    async function handleFactCheck(button) {
        const textToVerify = button.dataset.text;
        factCheckContent.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
        factCheckModal.classList.add('active');

        const prompt = `Based on public information, please fact-check the key claims in the following text. For each claim, state whether it is supported, refuted, or if there's insufficient information. Provide sources for your assessment.\n\nText to check:\n"${textToVerify}"`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ "google_search": {} }],
        };

        const data = await callApiWithRetry(apiUrl, payload);
        const candidate = data.candidates?.[0];

        if (candidate?.content?.parts?.[0]?.text) {
            let html = marked.parse(candidate.content.parts[0].text);
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata?.groundingAttributions?.length > 0) {
                html += '<h4 class="text-lg font-semibold mt-6 mb-2 text-white">Sources:</h4><ul class="list-disc list-inside space-y-1">';
                groundingMetadata.groundingAttributions.forEach(attribution => {
                    if (attribution.web) {
                         html += `<li><a href="${attribution.web.uri}" target="_blank" rel="noopener noreferrer" class="prose">${attribution.web.title}</a></li>`;
                    }
                });
                html += '</ul>';
            }
            factCheckContent.innerHTML = html;
        } else {
            factCheckContent.innerHTML = '<p class="text-red-400">Could not perform fact-check. Please try again.</p>';
        }
    }
    
    async function handleSummarize() {
        if (chatHistory.length < 2) {
            summaryContent.innerHTML = `<p>There isn't enough conversation to summarize yet.</p>`;
            summaryModal.classList.add('active');
            return;
        }
        summaryContent.innerHTML = `<p> Generating summary...</p>`;
        summaryModal.classList.add('active');
        
        const conversationText = chatHistory.map(turn => {
            const textPart = turn.parts.find(p => p.text)?.text || (turn.parts.find(p=>p.inlineData) ? '[Image]' : '');
            return `${turn.role === 'user' ? 'User' : 'YourGPT'}: ${textPart}`;
        }).join('\n');
        const summaryPrompt = `Please provide a concise summary of the following conversation in a few key bullet points:\n\n${conversationText}`;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: summaryPrompt }] }] };
        const data = await callApiWithRetry(apiUrl, payload);
        const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
        summaryContent.innerHTML = marked.parse(summary);
    }
    
    async function handleSuggestPrompts() {
        suggestedPromptsContainer.innerHTML = `<p class="text-sm text-gray-400"> Thinking of ideas...</p>`;
        let suggestionPrompt = (chatHistory.length === 0)
            ? "Suggest three creative and interesting questions to ask an AI assistant. Separate each suggestion with a newline. Do not add any prefixes like numbers or dashes."
            : `Based on this recent conversation:\n\n${chatHistory.slice(-4).map(t => `${t.role}: ${t.parts[0].text}`).join('\n')}\n\nSuggest three relevant follow-up questions. Separate each suggestion with a newline. Do not add prefixes.`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: suggestionPrompt }] }] };
        const data = await callApiWithRetry(apiUrl, payload);
        const suggestionsText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        suggestedPromptsContainer.innerHTML = '';
        if (suggestionsText) {
            suggestionsText.split('\n').filter(p => p.trim() !== '').forEach(promptText => {
                const button = document.createElement('button');
                button.className = 'bg-gray-600 hover:bg-gray-500 text-sm text-gray-200 px-3 py-1 rounded-lg transition-colors duration-200';
                button.textContent = promptText;
                button.onclick = () => { messageInput.value = promptText; chatForm.dispatchEvent(new Event('submit', { bubbles: true })); };
                suggestedPromptsContainer.appendChild(button);
            });
        } else {
            suggestedPromptsContainer.innerHTML = `<p class="text-sm text-red-400">Could not generate suggestions.</p>`;
        }
    }

    async function handleImageGeneration(e) {
        e.preventDefault();
        const prompt = imagePromptInput.value.trim();
        if (!prompt) return;

        imageDisplayArea.innerHTML = `<div class="loader"></div>`;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseModalities: ['IMAGE']
            },
        };
        const data = await callApiWithRetry(apiUrl, payload);
        const base64Data = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

        if (base64Data) {
            const imageUrl = `data:image/png;base64,${base64Data}`;
            imageDisplayArea.innerHTML = `
                <div class="relative">
                    <img src="${imageUrl}" alt="Generated image for prompt: ${prompt}" class="rounded-lg max-w-full h-auto">
                    <button title="Download Image" class="download-image-btn btn-futuristic p-2 rounded-full absolute top-2 right-2 opacity-0 hover:opacity-100 transition-opacity" data-image-url="${imageUrl}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </div>
            `;
            
            const userMessage = `Generated an image with prompt: "${prompt}"`;
            const botMessage = `Here is the image you requested:`;
            const userTimestamp = Date.now();
            const botTimestamp = userTimestamp + 1;

            if (welcomeScreen.style.display !== 'none') welcomeScreen.style.display = 'none';

            addMessageToChat('user', userMessage, {}, userTimestamp);
            addMessageToChat('bot', '', { imageUrl }, botTimestamp);
            
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
            chatHistory.push({ role: 'model', parts: [{ text: botMessage }], timestamp: botTimestamp });

            saveCurrentChat();
            
            imageModal.classList.remove('active');
            imagePromptInput.value = '';
        } else {
            console.error("Image generation failed. Response:", data);
            imageDisplayArea.innerHTML = `<p class="text-red-400">Failed to generate image. Please try again.</p>`;
        }
    }

    function handleCopyText(button) {
        const textToCopy = button.dataset.text;
        
        // Create a temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        
        // Select and copy the text
        textarea.select();
        textarea.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            document.execCommand('copy');
            
            // Show success feedback
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-neon);">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
            `;
            button.style.color = 'var(--accent-neon)';
            
            // Restore original icon after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.color = '';
            }, 2000);
            
        } catch (err) {
            console.error('Failed to copy text: ', err);
            // Fallback: try using the Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-neon);">
                            <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                    `;
                    button.style.color = 'var(--accent-neon)';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.color = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard API failed: ', err);
                    alert('Failed to copy text. Please try selecting and copying manually.');
                });
            } else {
                alert('Copy functionality not supported. Please try selecting and copying manually.');
            }
        }
        
        // Remove the temporary textarea
        document.body.removeChild(textarea);
    }

    function handleDownloadImage(button) {
        const imageUrl = button.dataset.imageUrl;
        if (!imageUrl) return;

        try {
            // Create a temporary anchor element for download
            const link = document.createElement('a');
            link.href = imageUrl;
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `yourgpt-generated-image-${timestamp}.png`;
            
            // Append to body, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success feedback
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-neon);">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
            `;
            
            // Restore original icon after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
            
        } catch (error) {
            console.error('Download failed:', error);
            
            // Show error feedback
            const originalHTML = button.innerHTML;
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            `;
            
            // Restore original icon after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        }
    }

    async function handleTTS(button) {
        if (activeAudio && !activeAudio.paused) activeAudio.pause();
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
        const textToSpeak = button.dataset.text;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: textToSpeak }] }],
            generationConfig: { responseModalities: ["AUDIO"] },
            model: "gemini-2.5-flash-preview-tts"
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        const audioData = data?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

        const originalIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;

        if (audioData) {
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, 24000);
            const audioUrl = URL.createObjectURL(wavBlob);
            activeAudio = new Audio(audioUrl);
            activeAudio.play();
            activeAudio.onended = () => button.innerHTML = originalIcon;
        } else {
            button.innerHTML = originalIcon;
            alert("Could not generate audio.");
        }
    }

    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function pcmToWav(pcmData, sampleRate) {
        const numChannels = 1, bitsPerSample = 16;
        const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
        const blockAlign = numChannels * (bitsPerSample / 8);
        const dataSize = pcmData.length * (bitsPerSample / 8);
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } }
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(view, 36, 'data');
        view.setUint32(40, dataSize, true);
        for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
        return new Blob([view], { type: 'audio/wav' });
    }

    // --- PWA INSTALLATION FUNCTIONALITY ---
    
    let deferredPrompt;
    let installButton;
    
    // Create install button
    function createInstallButton() {
        if (installButton) return;
        
        installButton = document.createElement('button');
        installButton.id = 'install-btn';
        installButton.className = 'fixed bottom-4 right-4 bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-50 hidden';
        installButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        `;
        installButton.title = 'Install YourGPT App';
        
        document.body.appendChild(installButton);
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                installButton.classList.add('hidden');
            }
        });
    }
    
    // Listen for the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('PWA install prompt triggered');
        e.preventDefault();
        deferredPrompt = e;
        createInstallButton();
        installButton.classList.remove('hidden');
    });
    
    // Listen for the appinstalled event
    window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        if (installButton) {
            installButton.classList.add('hidden');
        }
        deferredPrompt = null;
    });
    
    // Check if app is already installed
    window.addEventListener('load', () => {
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('App is running in standalone mode');
        }
    });
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }
    
    // --- MOBILE LAYOUT FIXES ---
    
    // Function to adjust mobile layout
    function adjustMobileLayout() {
        if (window.innerWidth <= 768) {
            const chatContainer = document.getElementById('chat-container');
            const header = document.querySelector('header');
            const chatForm = document.getElementById('chat-form');
            
            if (chatContainer && header && chatForm) {
                const headerHeight = header.offsetHeight;
                const formHeight = chatForm.offsetHeight;
                const availableHeight = window.innerHeight - headerHeight - formHeight - 20; // 20px margin
                
                chatContainer.style.height = `${availableHeight}px`;
                chatContainer.style.maxHeight = `${availableHeight}px`;
            }
        }
    }
    
    // Adjust layout on load and resize
    window.addEventListener('load', adjustMobileLayout);
    window.addEventListener('resize', adjustMobileLayout);
    window.addEventListener('orientationchange', () => {
        setTimeout(adjustMobileLayout, 100);
    });
    
    // Handle virtual keyboard on mobile
    let initialViewportHeight = window.innerHeight;
    window.addEventListener('resize', () => {
        const currentHeight = window.innerHeight;
        const heightDifference = initialViewportHeight - currentHeight;
        
        // If height decreased significantly, keyboard is likely open
        if (heightDifference > 150) {
            document.body.classList.add('keyboard-open');
        } else {
            document.body.classList.remove('keyboard-open');
        }
        
        adjustMobileLayout();
    });

</script>
</body>
</html>

